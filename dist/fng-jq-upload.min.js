!function(){"use strict";var e=angular.module("uploadModule",["blueimp.fileupload"]);e.controller("FngUploadAdditFieldsCtrl",["$scope","$timeout",function(i,e){function t(){i.schema&&i.schema.forEach(function(e){var a=i.uploadForm.dataField()[i.file];i.record[e.name]=a?a[e.name]:void 0})}i.record={},i.$watch("record",function(e,a){e!==a&&(i.uploadForm.formScope[i.uploadForm.formScope.topLevelFormName].$setDirty(),angular.extend(i.uploadForm.dataField()[i.file],e))},!0),e(function(){var a;i.formScope.newRecord?i.record={}:a=i.formScope.$watch("phase",function(e){"ready"===e&&(t(),i.$on("fngCancel",function(){t()}),a())})})}]).directive("fngUploadAdditFields",function(){return{link:function(e,a,i){e.uploadForm=e.$parent.$parent.$parent,e.formScope=e.uploadForm.formScope,e.schema=e.uploadForm.directiveOptions.additFields,e.file=parseInt(i.file)},scope:{},controller:"FngUploadAdditFieldsCtrl",template:'<form-input formstyle="inline" schema="schema" model="record" forceform="true"></form-input>'}}).controller("FngJqUploadCtrl",["$scope","$http",function(r,i){function c(e,a){return 1<e?i.get(a).then(e=>{if(201===e.status)return e.data.clientUrl;throw e="Unexpected response to getPresignedUrl (status"+e.status+")",new Error(e)}):Promise.resolve(a)}function s(a,e,i,t,n){var l=r.formScope.modelName+"/"+e;let o="/api/file/"+l+"/"+i;if(c(e,o).then(e=>{a.url=e}),a.deleteUrl=o,n&&(a.deleteUrl+=","+n),a.deleteType="DELETE",a.thumbnailUrl="https://upload.wikimedia.org/wikipedia/commons/6/6c/Iconoir_journal-page.svg",t&&!r.options.defaultThumbnail){var s=t.toLowerCase();for(const d of[".gif",".png",".jpg",".jpeg"])if(s.endsWith(d)){if(n){const o="/api/file/"+l+"/"+n;c(e,o).then(e=>{a.thumbnailUrl=e})}else a.thumbnailUrl="/api/file/"+l+"/thumbnail/"+i;break}}}function d(){r.formScope.fngJqUploadFileQueue=r.$$childHead.queue}function a(){var e=r.dataField();if(e){for(const n of e){var a=void 0===n.location?1:n.location,i=n.filename,t={name:i,size:n.size,location:a};s(t,a,n._id,i,n.thumbnailId),r.$$childHead.queue||(r.$$childHead.queue=[]),r.$$childHead.queue.push(t)}d()}}var t;r.loadingFiles=!1,r.formScope=r.$parent,r.dataField=function(e){if(-1===r.info.name.indexOf(".")){var a=r.formScope.record;if(!(o=a?a[r.info.name]:o)&&e){if(!a)throw new Error(`Cannot initialise record. ${r.info.name} - record is not defined`);o=a[r.info.name]=[]}}else if(r.options.subschema){for(var e=r.formScope.record,a=r.info.name,i=r.options.subschemaroot,a=a.slice(i.length+1),t=(o=e,i.split(".")),n=0,l=t.length;n<l;n++)o=o[t[n]];var o,e=r.options.index;if(void 0!==(e=void 0===e?r.$parent.$index:e)){if(!o[e])return;o[e][a]||(o[e][a]=[]),o=o[e][a]}else r.options.subkey?o=null!=(e=r.formScope["$_arrayOffset_"+i.replace(/\./g,"_")+"_"+r.options.subkeyno])&&void 0!==e&&-1!==e?o[e][a]:void 0:console.log("No support for this yet")}else console.log("No support for this yet either");return o},r.formScope.newRecord||(t=r.formScope.$watch("phase",function(e){"ready"===e&&(r.$$childHead.queue=r.$$childHead.queue||[],a(),r.$on("fngCancel",function(){r.$$childHead.queue=[],a()}),t())})),r.$on("fileuploadstart",function(){delete r.uploadError}),r.$on("fileuploadfail",function(e,a){r.$$childHead.queue.pop();let i;if(a.xhr){var t,n=a.xhr();try{t=JSON.parse(n.responseText),i=t.error||t}catch(e){i=n.responseText}}i=i||a.errorThrown||"an unexpected error occurred",r.uploadError=i}),r.$on("fileuploaddone",function(e,a){var i=r.dataField(!0),a=a.result.files[0],t=a.id,n=a.name,l=a.location,o=a.thumbnailId,i=(i.push({_id:t,filename:n,size:a.size,location:l,thumbnailId:o}),r.$$childHead.queue);s(i[i.length-1],l,t,n,o),r.ngModel.$setDirty(),d()})}]).directive("fngJqUploadForm",["PluginHelperService","$rootScope",function(n,l){return{link:function(e,a,i,t){angular.extend(e,n.extractFromAttr(i,"fngJqUploadForm",e.formScope,{setUpDynamicLabelFunc:!0})),e.label=e.formScope.label,e.passedParams=e.formScope[i.schema],angular.extend(e.options,e.passedParams.fngJqUploadForm),e.options.additFields&&(e.directiveOptions.additFields=JSON.parse(e.options.additFields)),e.directiveOptions.url="/api/file/upload/"+e.formScope.modelName+"/"+encodeURIComponent(e.info.name),e.directiveOptions.autoUpload=e.directiveOptions.autoupload,e.passedParams.readonly?e.isDisabled=!0:e.isDisabled="function"==typeof l.isSecurelyDisabled&&l.isSecurelyDisabled(e.info.id),e.name=e.passedParams.name,e.ngModel=t},restrict:"E",require:"?ngModel",templateUrl:"templates/fileform.html",scope:{},controller:"FngJqUploadCtrl"}}]).controller("FileDestroyController",["$scope","$http",function(l,a){function i(e){a=e.deleteUrl;for(var a,i=/\/file\/(.+?)\/([0-9a-f]{24})/.exec(a)[2],t=l.uploadScope.dataField(),n=t.length-1;0<=n;n--)t[n]._id===i&&t.splice(n,1);l.clear(e),l.ngModel.$setDirty()}var t,n=l.file;l.uploadScope=l.$parent.$parent.$parent;n.deleteUrl?(n.$state=function(){return t},n.$destroy=function(e){if(!e||!e.target.className.includes("ng-hide"))return l.$parent.$parent.mouseIn=!1,t="pending",a({url:n.deleteUrl,method:n.deleteType}).then(function(){t="resolved",i(n)},function(){t="rejected",i(n)})}):n.$cancel||n._index||(n.$cancel=function(){i(n)})}])}(),angular.module("uploadModule").run(["$templateCache",function(e){"use strict";e.put("templates/fileform.html",'<div class="form-group control-group" id=cg_f_{{info.name}} {{info.add}}><label for=f_{{info.name}} id={{info.name}}-label class="col-sm-3 control-label">{{label ? label() : (info.label || (info.name | titleCase))}}</label><div class="bs3-input col-sm-9 row-fluid"><div class="col-xs-12 span12 fileupload-form"><div class=fileupload method=POST enctype=multipart/form-data data-ng-app=demo data-file-upload=directiveOptions data-ng-class="{\'fileupload-processing\': processing() || loadingFiles}"><div class=controls><div class="row fileupload-buttonbar"><div class="col-md-12 span7" style="min-height: 60px;"><div data-ng-show="directiveOptions.single && queue.length === 0" class=pull-left><span class="btn btn-success fileinput-button" ng-class="{disabled: isDisabled}"><i class="glyphicon glyphicon-plus icon icon-plus"></i> <span>Upload {{label ? label() : (info.label || (info.name | titleCase))}}</span> <input type=file name=files ng-disabled=isDisabled placeholder="Upload {{ label ? label() : (info.label || (info.name | titleCase))}}"></span></div><div data-ng-show=directiveOptions.single class=pull-left><div class=preview ng-show=!!queue[0].thumbnailUrl><a data-ng-href={{queue[0].url}} title={{queue[0].name}} download={{queue[0].name}} target=_blank data-gallery ng-mouseover="mouseIn=1" ng-mouseout="mouseIn=0"><img data-ng-src={{queue[0].thumbnailUrl}} alt="" width="{{ options.width || 80 }}" height="{{ options.height || 60 }}"></a></div></div><div data-ng-show=directiveOptions.single class="pull-left file-delete-div"><button ng-show="mouseIn && !isDisabled" class="file-delete overlay-btn" aria-label=Delete ng-mouseover="mouseIn=1" data-ng-click=queue[0].$destroy($event)><i class="glyphicon glyphicon-trash icon icon-trash"></i></button></div><span data-ng-hide=directiveOptions.single><span class="btn btn-success fileinput-button" ng-class="{disabled: isDisabled}"><i class="glyphicon glyphicon-plus icon icon-plus"></i> <span>Add files...</span> <input type=file name=files multiple ng-disabled=isDisabled placeholder="Upload {{info.label || (info.name | titleCase)}}"> </span></span><button type=button data-ng-hide=directiveOptions.autoupload class="btn btn-primary start" data-ng-click=submit()><i class="glyphicon glyphicon-upload icon icon-upload"></i> <span>Start upload</span></button> <button data-ng-show=active() type=button class="btn btn-warning cancel" data-ng-click=cancel()><i class="glyphicon glyphicon-ban icon-circle icon-ban-circle"></i> <span>Cancel upload</span></button><div data-ng-show=uploadError style="padding-top: 5px;"><span class="error text-danger">{{ uploadError }}</span></div><span class=fileupload-process></span></div><div class="col-md-5 span5 fade" data-ng-class="{in: active()}"><div class="progress progress-striped active" data-file-upload-progress=progress()><div class="progress-bar progress-bar-success" data-ng-style="{width: num + \'%\'}"></div></div><div class=progress-extended>&nbsp;</div></div></div><table data-ng-hide=directiveOptions.single class="table table-striped files ng-cloak"><tr data-ng-repeat="file in queue"><td data-ng-switch data-on=!!file.thumbnailUrl><div class=preview data-ng-switch-when=true><a data-ng-href={{file.url}} title={{file.name}} download={{file.name}} target=_blank data-gallery><img data-ng-src={{file.thumbnailUrl}} alt="" width=80 height=60></a></div><div class=preview data-ng-switch-default data-file-upload-preview=file></div></td><td><p class=name data-ng-switch data-on=!!file.url><span data-ng-switch-when=true data-ng-switch data-on=!!file.thumbnailUrl><a data-ng-switch-when=true data-ng-href={{file.url}} title={{file.name}} download={{file.name}} target=_blank data-gallery>{{file.name}}</a> <a data-ng-switch-default data-ng-href={{file.url}} title={{file.name}} download={{file.name}}>{{file.name}}</a> </span><span data-ng-switch-default>{{file.name}}</span></p><strong data-ng-show=file.error class="error text-danger">{{file.error}}</strong></td><td><p class=size>{{file.size | formatFileSize}}</p><div class="progress progress-striped active fade" data-ng-class="{pending: \'in\'}[file.$state()]" data-file-upload-progress=file.$progress()><div class="progress-bar progress-bar-success" data-ng-style="{width: num + \'%\'}"></div></div></td><td ng-show=directiveOptions.additFields><fng-upload-addit-fields file={{$index}}></fng-upload-addit-fields></td><td><button type=button class="btn btn-primary start" data-ng-click=file.$submit() data-ng-hide="!file.$submit || directiveOptions.autoupload" data-ng-disabled="file.$state() == \'pending\' || file.$state() == \'rejected\'"><i class="glyphicon glyphicon-upload icon icon-upload"></i> <span>Start</span></button> <button type=button class="btn btn-warning cancel" data-ng-click=file.$cancel() data-ng-hide=!file.$cancel><i class="glyphicon glyphicon-ban-circle icon icon-ban-circle"></i> <span>Cancel</span></button> <button type=button class="btn btn-danger destroy" data-ng-click=file.$destroy() data-ng-hide="!file.$destroy || isDisabled" data-ng-controller=FileDestroyController><i class="glyphicon glyphicon-trash icon icon-trash"></i> <span>Delete</span></button></td></tr></table></div></div></div></div></div>')}]);